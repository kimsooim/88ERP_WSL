name: Deploy to Production Server

on:
  # push:
  #   branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    # ìš´ì˜ ì„œë²„ ì €ì¥ì†Œë¡œ ì½”ë“œ ë™ê¸°í™”
    - name: Sync to Production Repository
      env:
        PROD_REPO_TOKEN: ${{ secrets.PROD_REPO_TOKEN }}
      run: |
        # Git ì„¤ì •
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # ìš´ì˜ ì„œë²„ ì €ì¥ì†Œ í´ë¡ 
        git clone https://${PROD_REPO_TOKEN}@github.com/kimsooim/88ERP_server.git prod_repo
        cd prod_repo
        
        # ê¸°ì¡´ íŒŒì¼ ì •ë¦¬ (git ì œì™¸)
        find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.gitignore' -exec rm -rf {} +
        
        # í•„ìš”í•œ íŒŒì¼ ë³µì‚¬
        cp -r ../projects/web-dashboard ./projects/
        cp ../docker-compose.prod.yml ./docker-compose.yml
        cp ../Dockerfile.prod ./Dockerfile
        cp ../.dockerignore ./
        cp ../.env.example ./
        
        # ì»¤ë°‹ ë° í‘¸ì‹œ
        git add -A
        git commit -m "ğŸš€ Auto deploy from development - ${{ github.sha }}" || true
        git push origin main
    
    # ìš´ì˜ ì„œë²„ì— ë°°í¬
    - name: Deploy to Production Server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        port: 22
        script: |
          cd /root/88ERP
          
          # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (88ERP_server ì €ì¥ì†Œì—ì„œ)
          git pull origin main
          
          # Docker ì¬ì‹œì‘
          docker-compose down
          docker-compose up -d --build
          
          # í—¬ìŠ¤ì²´í¬
          sleep 15
          curl -f http://localhost:3000 || exit 1
          
          echo "âœ… Deployment completed successfully!"